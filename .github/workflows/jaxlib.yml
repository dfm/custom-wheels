name: jaxlib / osx-arm64

on:
  release:
    types:
      - published
  pull_request:
  push:
    branches: [ main ]
jobs:
  build:
    name: jaxlib ${{ matrix.jaxlib-version }} / Python ${{ matrix.python-version }}
    runs-on: macos-latest
    strategy:
      matrix:
        jaxlib-version: ['v0.1.70']
        python-version: ['3.8', '3.9']

    steps:
      - name: Fetch JAX source
        run: |
          wget -q https://github.com/google/jax/archive/refs/tags/jaxlib-${{ matrix.jaxlib-version }}.tar.gz
          tar xvf jaxlib-${{ matrix.jaxlib-version }}.tar.gz --strip-components=1 -C .
          
      - name: Cache Bazel build products
        uses: actions/cache@v2
        with:
          path: '~/bazel-build-cache'
          key: ${{ runner.os }}-${{ matrix.python-version }}-${{ matrix.jaxlib-version }}

      - name: Install Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Install build dependencies
        run: |
          python -m pip install -U pip
          python -m pip install numpy scipy wheel future six

      - name: Build jaxlib
        run: python build/build.py --target_cpu darwin_arm64 --bazel_startup_options="--output_base=~/bazel-build-cache"

      - uses: actions/upload-artifact@v2
        with:
          name: wheels
          path: ./dist/*.whl

  index:
    needs: [build]
    runs-on: ubuntu-latest
    # if: github.event_name == 'release' && github.event.action == 'published'
    steps:
      - uses: actions/checkout@v2

      - run: git clone --single-branch --branch index https://github.com/dfm/custom-wheels index

      - uses: actions/download-artifact@v2
        with:
          name: wheels
          path: output/jaxlib

      - run: |
          cd index
          rm -rf .git
          git init .
          git checkout -b index
          git add .
          git -c user.name='gh-actions' -c user.email='gh-actions' commit -m "updating index"
          git push --force https://x-access-token:${GITHUB_TOKEN}@github.com/dfm/custom-wheels index
        env:
          GITHUB_TOKEN: ${{ secrets.github_token }}